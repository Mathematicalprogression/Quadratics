<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>welcome aki hehe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .security-badge {
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }

        .join-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .join-screen h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .privacy-notice {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid #f093fb;
            color: #333;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 400px;
            font-size: 14px;
            text-align: center;
        }

        .privacy-notice strong {
            display: block;
            margin-bottom: 5px;
        }

        .join-screen input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .join-screen button {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .join-screen button:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .chat-screen {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        .chat-screen.active {
            display: flex;
        }

        .room-info {
            background: #f9f9f9;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-code {
            font-weight: bold;
            color: #f093fb;
        }

        .encryption-indicator {
            font-size: 12px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .leave-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.own {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other .message-bubble {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .message img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 5px;
            cursor: pointer;
        }

        .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .input-area input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 15px;
        }

        .input-area button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .input-area button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .file-input-label {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        input[type="file"] {
            display: none;
        }

        .status {
            text-align: center;
            padding: 8px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            font-size: 14px;
        }

        .status.connected {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .info-text {
            margin-top: 15px;
            color: #666;
            font-size: 13px;
            text-align: center;
            max-width: 400px;
            line-height: 1.5;
        }

        .setup-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .setup-notice strong {
            color: #856404;
        }

        .decryption-error {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 8px;
            margin: 10px 20px;
            text-align: center;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí¨ welcome aki hehe</h1>
            <div class="security-badge" style="font-size: 11px; opacity: 0.9;">who let me cook this hard</div>
        </div>

        <!-- Join Screen -->
        <div class="join-screen" id="joinScreen">
            <h2>drop ur room code ‚ú®</h2>
            <div class="privacy-notice">
                <strong>üîí totally private btw</strong>
                everything's encrypted so only u and ur friend can see the msgs. no one else can read em even if they tried lol
            </div>
            <input type="text" id="roomCodeInput" placeholder="room code here..." maxlength="20">
            <button onclick="joinRoom()">let's go üöÄ</button>
            <p class="info-text">
                just share the same code with ur friend and yall can chat. make it something random so nobody else can guess it
            </p>
        </div>

        <!-- Chat Screen -->
        <div class="chat-screen" id="chatScreen">
            <div class="room-info">
                <div>
                    <span>room: <span class="room-code" id="currentRoom"></span></span>
                    <div class="encryption-indicator">üîê locked down</div>
                </div>
                <button class="leave-btn" onclick="leaveRoom()">peace out ‚úåÔ∏è</button>
            </div>
            <div class="status" id="status">Connecting...</div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <label for="imageInput" class="file-input-label">üìé</label>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload()">
                <input type="text" id="imageUrlInput" placeholder="paste image link...">
                <input type="text" id="messageInput" placeholder="say something..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">send it</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- CryptoJS for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // FIREBASE CONFIGURATION
        // YOU NEED TO REPLACE THIS WITH YOUR OWN FIREBASE CONFIG
	const firebaseConfig = {
  	    apiKey: "AIzaSyBNaT6APrxbHpu7Gl_NS9FSSKc69xHGRQE",
  	    authDomain: "mathematicsig.firebaseapp.com",
  	    databaseURL: "https://mathematicsig-default-rtdb.europe-west1.firebasedatabase.app",
  	    projectId: "mathematicsig",
  	    storageBucket: "mathematicsig.firebasestorage.app",
  	    messagingSenderId: "389742861473",
  	    appId: "1:389742861473:web:f643c438a5f07b8e4364e0"
	};

        // Check if Firebase is configured
        if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
            document.getElementById('joinScreen').innerHTML = `
                <div class="setup-notice">
                    <h2>‚ö†Ô∏è Setup Required</h2>
                    <p><strong>You need to set up Firebase first!</strong></p>
                    <p style="margin-top: 10px;">Follow the instructions in the SETUP_GUIDE.md file.</p>
                    <p style="margin-top: 10px; font-size: 13px;">This takes about 2 minutes and is completely free.</p>
                </div>
            `;
        }

        // Initialize Firebase
        let app, database, currentRoomRef, messagesRef;
        let currentRoom = '';
        let encryptionKey = '';
        let userName = 'user_' + Math.random().toString(36).substr(2, 9);
        let isInitialized = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isInitialized = true;
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // ENCRYPTION FUNCTIONS
        function encrypt(text, key) {
            try {
                return CryptoJS.AES.encrypt(text, key).toString();
            } catch (error) {
                console.error('Encryption error:', error);
                return null;
            }
        }

        function decrypt(encryptedText, key) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedText, key);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                if (!decrypted) {
                    return null;
                }
                return decrypted;
            } catch (error) {
                console.error('Decryption error:', error);
                return null;
            }
        }

        function joinRoom() {
            if (!isInitialized) {
                alert('Firebase is not configured. Please add your Firebase config.');
                return;
            }

            const roomCode = document.getElementById('roomCodeInput').value.trim();
            if (roomCode.length < 6) {
                alert('yo make ur room code at least 6 characters for security fr');
                return;
            }

            currentRoom = roomCode.toUpperCase();
            encryptionKey = roomCode; // The room code IS the encryption key
            
            document.getElementById('currentRoom').textContent = currentRoom;
            document.getElementById('joinScreen').style.display = 'none';
            document.getElementById('chatScreen').classList.add('active');

            // Reference to the room
            currentRoomRef = database.ref('rooms/' + currentRoom);
            messagesRef = currentRoomRef.child('messages');

            // Listen for new messages in real-time
            messagesRef.on('child_added', (snapshot) => {
                const encryptedMessage = snapshot.val();
                const decryptedMessage = decryptMessage(encryptedMessage);
                
                if (decryptedMessage) {
                    addMessageToUI(decryptedMessage);
                    scrollToBottom();
                } else {
                    // Message couldn't be decrypted (wrong room code or corrupted)
                    console.warn('Could not decrypt message');
                }
            });

            // Update status
            updateStatus();

            // Listen for presence (encrypted user IDs)
            const encryptedUserId = encrypt(userName, encryptionKey);
            const presenceRef = currentRoomRef.child('presence').child(encryptedUserId);
            presenceRef.set(true);
            presenceRef.onDisconnect().remove();

            // Listen for other users
            currentRoomRef.child('presence').on('value', (snapshot) => {
                const users = snapshot.val();
                const userCount = users ? Object.keys(users).length : 0;
                updateStatus(userCount);
            });
        }

        function leaveRoom() {
            if (currentRoomRef) {
                const encryptedUserId = encrypt(userName, encryptionKey);
                currentRoomRef.child('presence').child(encryptedUserId).remove();
                messagesRef.off();
                currentRoomRef.off();
            }

            currentRoom = '';
            encryptionKey = '';
            document.getElementById('joinScreen').style.display = 'flex';
            document.getElementById('chatScreen').classList.remove('active');
            document.getElementById('messages').innerHTML = '';
            document.getElementById('roomCodeInput').value = '';
        }

        function updateStatus(userCount = 0) {
            const statusDiv = document.getElementById('status');
            if (userCount > 1) {
                statusDiv.textContent = `üîí yall connected - ${userCount} peeps in here`;
                statusDiv.className = 'status connected';
            } else if (userCount === 1) {
                statusDiv.textContent = '‚è≥ waiting for ur friend to join...';
                statusDiv.className = 'status';
            } else {
                statusDiv.textContent = 'connecting...';
                statusDiv.className = 'status';
            }
        }

        function decryptMessage(encMsg) {
            try {
                const decryptedContent = decrypt(encMsg.content, encryptionKey);
                if (!decryptedContent) return null;

                const decryptedUser = decrypt(encMsg.user, encryptionKey);
                if (!decryptedUser) return null;

                return {
                    type: encMsg.type,
                    content: decryptedContent,
                    user: decryptedUser,
                    timestamp: encMsg.timestamp
                };
            } catch (error) {
                return null;
            }
        }

        function addMessageToUI(msg) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = msg.user === userName ? 'message own' : 'message other';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            if (msg.type === 'text') {
                bubble.textContent = msg.content;
            } else if (msg.type === 'image') {
                const img = document.createElement('img');
                img.src = msg.content;
                img.alt = 'Shared image';
                img.onclick = () => window.open(msg.content, '_blank');
                bubble.appendChild(img);
            }

            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date(msg.timestamp).toLocaleTimeString();

            messageDiv.appendChild(bubble);
            messageDiv.appendChild(timestamp);
            messagesDiv.appendChild(messageDiv);
        }

        function sendMessage() {
            if (!isInitialized || !currentRoom) return;

            const input = document.getElementById('messageInput');
            const imageUrlInput = document.getElementById('imageUrlInput');
            const message = input.value.trim();
            const imageUrl = imageUrlInput.value.trim();

            if (!message && !imageUrl) return;

            if (message) {
                const encryptedMessage = {
                    type: 'text',
                    content: encrypt(message, encryptionKey),
                    user: encrypt(userName, encryptionKey),
                    timestamp: Date.now()
                };

                messagesRef.push(encryptedMessage);
                input.value = '';
            }

            if (imageUrl) {
                const encryptedMessage = {
                    type: 'image',
                    content: encrypt(imageUrl, encryptionKey),
                    user: encrypt(userName, encryptionKey),
                    timestamp: Date.now()
                };

                messagesRef.push(encryptedMessage);
                imageUrlInput.value = '';
            }
        }

        function handleImageUpload() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const statusDiv = document.getElementById('status');
                const originalStatus = statusDiv.textContent;
                statusDiv.textContent = 'encrypting ur pic...';

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Check size
                    if (e.target.result.length > 900000) {
                        alert('bruh that image is too big. use a smaller one or just paste the link instead');
                        statusDiv.textContent = originalStatus;
                        return;
                    }

                    const encryptedMessage = {
                        type: 'image',
                        content: encrypt(e.target.result, encryptionKey),
                        user: encrypt(userName, encryptionKey),
                        timestamp: Date.now()
                    };

                    messagesRef.push(encryptedMessage);
                    statusDiv.textContent = originalStatus;
                };
                reader.readAsDataURL(file);
            }
            
            fileInput.value = '';
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (currentRoomRef && encryptionKey) {
                const encryptedUserId = encrypt(userName, encryptionKey);
                currentRoomRef.child('presence').child(encryptedUserId).remove();
            }
        });
    </script>
</body>
</html>
