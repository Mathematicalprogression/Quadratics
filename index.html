<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uhm welcome i guess</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .password-screen { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .password-screen.hidden { display: none; }
        .access-box {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .access-box h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .subtitle { color: #666; font-size: 14px; margin-bottom: 30px; font-style: italic; }
        .info-text { color: #555; font-size: 15px; margin-bottom: 25px; line-height: 1.5; }
        .access-box input {
            width: 100%; padding: 15px 20px; margin: 15px 0;
            border: 2px solid #ddd; border-radius: 12px;
            font-size: 16px; text-align: center; transition: all 0.3s ease;
        }
        .access-box input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .access-box button {
            width: 100%; padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        }
        .access-box button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .emoji { font-size: 3em; margin-bottom: 20px; }
        .container {
            max-width: 800px; width: 100%; margin: 0 auto;
            background: white; height: 100vh;
            display: none; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .container.active { display: flex; }
        .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px 20px; text-align: center; }
        .security-badge { font-size: 11px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; }
        .join-screen { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .join-screen h2 { margin-bottom: 10px; color: #333; }
        .privacy-notice {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid #f093fb; color: #333; padding: 12px;
            border-radius: 12px; margin-bottom: 20px;
            max-width: 400px; font-size: 14px; text-align: center;
        }
        .privacy-notice strong { display: block; margin-bottom: 5px; }
        .join-screen input {
            width: 100%; max-width: 300px; padding: 12px; font-size: 16px;
            border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;
            text-align: center; text-transform: uppercase;
        }
        .join-screen button {
            width: 100%; max-width: 300px; padding: 12px; font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .join-screen button:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); transform: scale(1.05); transition: all 0.3s ease; }
        .chat-screen { display: none; flex: 1; flex-direction: column; height: 100%; }
        .chat-screen.active { display: flex; }
        .room-info { background: #f9f9f9; padding: 10px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .room-code { font-weight: bold; color: #f093fb; }
        .encryption-indicator { font-size: 12px; color: #667eea; display: flex; align-items: center; gap: 5px; }
        .leave-btn { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; background: #fafafa; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; position: relative; }
        .message.own { align-items: flex-end; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; position: relative; cursor: pointer; user-select: none; }
        .message.own .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; }
        .message.other .message-bubble { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .reply-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.1); border-radius: 50%;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 14px;
        }
        .message.own .reply-arrow { left: -30px; }
        .message.other .reply-arrow { right: -30px; }
        .message:hover .reply-arrow { opacity: 1; }
        .reply-arrow:hover { background: rgba(0,0,0,0.2); }
        .replied-message { background: rgba(0,0,0,0.1); padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; border-left: 3px solid rgba(255,255,255,0.5); }
        .replied-message-text { opacity: 0.9; font-style: italic; }
        .replying-to-banner { background: rgba(102,126,234,0.1); padding: 10px 15px; border-left: 3px solid #667eea; margin: 10px 15px 0; border-radius: 4px; display: none; align-items: center; justify-content: space-between; }
        .replying-to-banner.active { display: flex; }
        .replying-to-text { font-size: 13px; color: #555; font-style: italic; flex: 1; }
        .cancel-reply { background: none; border: none; color: #e74c3c; cursor: pointer; padding: 5px 10px; font-size: 18px; }
        .message img { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .timestamp { font-size: 11px; color: #999; margin-top: 4px; }
        .input-area { padding: 15px; background: white; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; }
        .input-area input[type="text"] { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 15px; }
        .input-area button { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .input-area button:hover { background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); transform: scale(1.05); transition: all 0.3s ease; }
        .file-input-label { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 10px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 40px; }
        .file-input-label:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); transform: scale(1.05); transition: all 0.3s ease; }
        input[type="file"] { display: none; }
        .status { text-align: center; padding: 8px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; font-size: 14px; }
        .status.connected { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .join-screen .info-text { margin-top: 15px; color: #666; font-size: 13px; text-align: center; max-width: 400px; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="password-screen" id="passwordScreen">
        <div class="access-box">
            <div class="emoji">üìù</div>
            <h1>MATHEMATICS</h1>
            <p class="subtitle">Please Note That some topics may not be available currently</p>
            <p class="info-text">Enter what Topic you Want</p>
            <input type="password" id="topicInput" placeholder="topic..." autocomplete="off">
            <button onclick="checkPassword()">Begin</button>
        </div>
    </div>

    <div class="container" id="chatContainer">
        <div class="header">
            <h1>üí¨ welcome aki hehehehehehe</h1>
            <div class="security-badge">who let me cook this hard</div>
        </div>
        <div class="join-screen" id="joinScreen">
            <h2>drop ur room code ‚ú®</h2>
            <div class="privacy-notice">
                <strong>üîí totally private btw</strong>
                everything's encrypted so only u and me can see the msgs. no one else can read ts even if they tried lol
            </div>
            <input type="text" id="roomCodeInput" placeholder="room code here..." maxlength="20">
            <button onclick="joinRoom()">les go üöÄ</button>
            <p class="info-text">we just need to have the same room code. (also i may have used some AI).</p>
        </div>
        <div class="chat-screen" id="chatScreen">
            <div class="room-info">
                <div>
                    <span>room: <span class="room-code" id="currentRoom"></span></span>
                    <div class="encryption-indicator">üîê locked down</div>
                </div>
                <button class="leave-btn" onclick="leaveRoom()">ily cya</button>
            </div>
            <div class="status" id="status">connecting...</div>
            <div class="replying-to-banner" id="replyingBanner">
                <span class="replying-to-text" id="replyingToText">Replying to: Message...</span>
                <button class="cancel-reply" onclick="cancelReply()">‚úï</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <label for="imageInput" class="file-input-label">üìé</label>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload()">
                <input type="text" id="imageUrlInput" placeholder="paste image link...">
                <input type="text" id="messageInput" placeholder="say something..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">send it</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const CORRECT_PASSWORD = "iloveyou";
        const REDIRECT_URL = "https://vle.mathswatch.co.uk/vle/";

        // Run immediately - no load event needed
        if (sessionStorage.getItem('authenticated') === 'true') {
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('chatContainer').classList.add('active');
        }

        function checkPassword() {
            const input = document.getElementById('topicInput').value;
            if (input === CORRECT_PASSWORD) {
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('chatContainer').classList.add('active');
            } else {
                window.location.href = REDIRECT_URL;
            }
        }

        document.getElementById('topicInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });

        const firebaseConfig = {
            apiKey: "AIzaSyBNaT6APrxbHpu7Gl_NS9FSSKc69xHGRQE",
            authDomain: "mathematicsig.firebaseapp.com",
            databaseURL: "https://mathematicsig-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mathematicsig",
            storageBucket: "mathematicsig.firebasestorage.app",
            messagingSenderId: "389742861473",
            appId: "1:389742861473:web:f643c438a5f07b8e4364e0"
        };

        let app, database, currentRoomRef, messagesRef;
        let currentRoom = '', encryptionKey = '';
        let userName = 'user_' + Math.random().toString(36).substr(2, 9);
        let isInitialized = false;
        let replyingToMessage = null;
        let lastTapTime = 0, lastTapTarget = null;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isInitialized = true;
        } catch (error) { console.error("Firebase init error:", error); }

        function encrypt(text, key) {
            try { return CryptoJS.AES.encrypt(text, key).toString(); }
            catch (e) { return null; }
        }
        function decrypt(encryptedText, key) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedText, key);
                const dec = bytes.toString(CryptoJS.enc.Utf8);
                return dec || null;
            } catch (e) { return null; }
        }

        function setReplyingTo(messageId, messageText) {
            replyingToMessage = { id: messageId, text: messageText };
            document.getElementById('replyingToText').textContent = `Replying to: ${messageText.substring(0, 50)}${messageText.length > 50 ? '...' : ''}`;
            document.getElementById('replyingBanner').classList.add('active');
            document.getElementById('messageInput').focus();
        }
        function cancelReply() {
            replyingToMessage = null;
            document.getElementById('replyingBanner').classList.remove('active');
        }

        function joinRoom() {
            if (!isInitialized) { alert('Firebase not configured.'); return; }
            const roomCode = document.getElementById('roomCodeInput').value.trim();
            if (roomCode.length < 6) { alert('yo make ur room code at least 6 characters for security fr'); return; }
            currentRoom = roomCode.toUpperCase();
            encryptionKey = roomCode;
            document.getElementById('currentRoom').textContent = currentRoom;
            document.getElementById('joinScreen').style.display = 'none';
            document.getElementById('chatScreen').classList.add('active');
            currentRoomRef = database.ref('rooms/' + currentRoom);
            messagesRef = currentRoomRef.child('messages');
            messagesRef.on('child_added', (snapshot) => {
                const msg = decryptMessage(snapshot.val());
                if (msg) { addMessageToUI(msg, snapshot.key); scrollToBottom(); }
            });
            updateStatus();
            const encUID = encrypt(userName, encryptionKey);
            const presRef = currentRoomRef.child('presence').child(encUID);
            presRef.set(true);
            presRef.onDisconnect().remove();
            currentRoomRef.child('presence').on('value', (snap) => {
                const u = snap.val();
                updateStatus(u ? Object.keys(u).length : 0);
            });
        }

        function leaveRoom() {
            if (currentRoomRef) {
                currentRoomRef.child('presence').child(encrypt(userName, encryptionKey)).remove();
                messagesRef.off(); currentRoomRef.off();
            }
            currentRoom = ''; encryptionKey = ''; replyingToMessage = null;
            document.getElementById('joinScreen').style.display = 'flex';
            document.getElementById('chatScreen').classList.remove('active');
            document.getElementById('messages').innerHTML = '';
            document.getElementById('roomCodeInput').value = '';
            document.getElementById('replyingBanner').classList.remove('active');
        }

        function updateStatus(userCount = 0) {
            const s = document.getElementById('status');
            if (userCount > 1) { s.textContent = `üîí yall connected - ${userCount} peeps in here`; s.className = 'status connected'; }
            else if (userCount === 1) { s.textContent = '‚è≥ waiting for ur friend to join...'; s.className = 'status'; }
            else { s.textContent = 'connecting...'; s.className = 'status'; }
        }

        function decryptMessage(encMsg) {
            try {
                const content = decrypt(encMsg.content, encryptionKey); if (!content) return null;
                const user = decrypt(encMsg.user, encryptionKey); if (!user) return null;
                let replyTo = null;
                if (encMsg.replyTo) {
                    const rt = decrypt(encMsg.replyTo.text, encryptionKey);
                    if (rt) replyTo = { id: encMsg.replyTo.id, text: rt };
                }
                return { type: encMsg.type, content, user, timestamp: encMsg.timestamp, replyTo };
            } catch (e) { return null; }
        }

        function addMessageToUI(msg, messageId) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = msg.user === userName ? 'message own' : 'message other';
            messageDiv.setAttribute('data-message-id', messageId);
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            if (msg.replyTo) {
                const rm = document.createElement('div'); rm.className = 'replied-message';
                const rt = document.createElement('div'); rt.className = 'replied-message-text';
                rt.textContent = msg.replyTo.text.substring(0, 50) + (msg.replyTo.text.length > 50 ? '...' : '');
                rm.appendChild(rt); bubble.appendChild(rm);
            }
            if (msg.type === 'text') {
                bubble.appendChild(document.createTextNode(msg.content));
            } else if (msg.type === 'image') {
                const img = document.createElement('img');
                img.src = msg.content; img.alt = 'Shared image';
                img.onclick = () => window.open(msg.content, '_blank');
                bubble.appendChild(img);
            }
            const replyArrow = document.createElement('div');
            replyArrow.className = 'reply-arrow'; replyArrow.innerHTML = '‚Ü©';
            replyArrow.onclick = () => setReplyingTo(messageId, msg.content);
            bubble.addEventListener('click', function() {
                const now = new Date().getTime();
                if (now - lastTapTime < 500 && now - lastTapTime > 0 && lastTapTarget === bubble) {
                    setReplyingTo(messageId, msg.content);
                }
                lastTapTime = now; lastTapTarget = bubble;
            });
            const ts = document.createElement('div'); ts.className = 'timestamp';
            ts.textContent = new Date(msg.timestamp).toLocaleTimeString();
            messageDiv.appendChild(replyArrow); messageDiv.appendChild(bubble); messageDiv.appendChild(ts);
            messagesDiv.appendChild(messageDiv);
        }

        function sendMessage() {
            if (!isInitialized || !currentRoom) return;
            const input = document.getElementById('messageInput');
            const imageUrlInput = document.getElementById('imageUrlInput');
            const message = input.value.trim();
            const imageUrl = imageUrlInput.value.trim();
            if (!message && !imageUrl) return;
            if (message) {
                const em = { type: 'text', content: encrypt(message, encryptionKey), user: encrypt(userName, encryptionKey), timestamp: Date.now() };
                if (replyingToMessage) em.replyTo = { id: replyingToMessage.id, text: encrypt(replyingToMessage.text, encryptionKey) };
                messagesRef.push(em); input.value = ''; cancelReply();
            }
            if (imageUrl) {
                const em = { type: 'image', content: encrypt(imageUrl, encryptionKey), user: encrypt(userName, encryptionKey), timestamp: Date.now() };
                if (replyingToMessage) em.replyTo = { id: replyingToMessage.id, text: encrypt(replyingToMessage.text, encryptionKey) };
                messagesRef.push(em); imageUrlInput.value = ''; cancelReply();
            }
        }

        function handleImageUpload() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            if (file && file.type.startsWith('image/')) {
                const s = document.getElementById('status');
                const orig = s.textContent; s.textContent = 'encrypting ur pic...';
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (e.target.result.length > 900000) {
                        alert('bruh that image is too big. use a smaller one or just paste the link instead');
                        s.textContent = orig; return;
                    }
                    const em = { type: 'image', content: encrypt(e.target.result, encryptionKey), user: encrypt(userName, encryptionKey), timestamp: Date.now() };
                    if (replyingToMessage) em.replyTo = { id: replyingToMessage.id, text: encrypt(replyingToMessage.text, encryptionKey) };
                    messagesRef.push(em); s.textContent = orig; cancelReply();
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        }

        function scrollToBottom() { const m = document.getElementById('messages'); m.scrollTop = m.scrollHeight; }
        function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }
        window.addEventListener('beforeunload', () => {
            if (currentRoomRef && encryptionKey) currentRoomRef.child('presence').child(encrypt(userName, encryptionKey)).remove();
        });
    </script>
</body>
</html>
